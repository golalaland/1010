<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CUBE SIP PICKER</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #111;
      --text: #fff;
      --green: #00ff9d;
      --border: #222;
    }
    * { margin:0; padding:0; box-sizing:border-box; touch-action: manipulation; }
    html, body {
      height:100%; width:100%; overflow:hidden;
      background:var(--bg); color:var(--text);
      font-family:system-ui, sans-serif;
    }
    body {
      display:flex; justify-content:center; align-items:flex-start;
    }
    .container {
      width:100%; max-width:480px; height:100vh;
      padding:20px; text-align:center; overflow-y:auto;
      -webkit-overflow-scrolling:touch; position:relative;
    }

    .title {
      font-size:42px; font-weight:900;
      background:linear-gradient(90deg,#00ff9d,#39ff14);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      margin:15px 0 8px;
    }
    .welcome {
      font-size:19px; margin:12px 0 25px; font-weight:600;
    }
    .welcome span { color:var(--green); }

    .balance {
      background:rgba(17,17,17,0.8); backdrop-filter:blur(12px);
      border:1px solid #222; border-radius:16px;
      padding:16px 24px; width:fit-content; margin:20px auto;
      font-size:18px;
    }
    .item { display:flex; align-items:center; gap:10px; margin:8px 0; }
    .label { font-weight:900; min-width:70px; }
    #stars-count { color:#FFD700; }

    .marquee {
      overflow:hidden; white-space:nowrap; margin:35px 0;
      background:#111; padding:16px 0; border-radius:20px; border:2px solid var(--border);
    }
    .marquee-inner { display:inline-block; animation:marquee 45s linear infinite; }
    .marquee img {
      width:110px; height:110px; object-fit:cover; margin:0 22px;
      border-radius:16px; border:3px solid var(--green);
    }

    h2.pick-title {
      font-size:34px; font-weight:900; color:#fff;
      margin:50px 0 30px; letter-spacing:2px; text-transform:uppercase;
    }

    .cards-grid {
      display:grid; grid-template-columns:repeat(4,1fr); gap:18px;
      perspective:1200px; margin:30px 0 120px;
    }
    .card {
      width:100%; height:130px; position:relative;
      transform-style:preserve-3d; cursor:pointer;
      border-radius:20px; border:1px solid var(--border);
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      transition:transform 0.7s cubic-bezier(0.175,0.885,0.32,1.275);
    }
    .card:hover { transform:translateY(-10px) scale(1.05); }
    .card-face {
      position:absolute; inset:0; backface-visibility:hidden;
      border-radius:20px; display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:14px; padding:12px;
      border:1px solid var(--green);
    }
    .card-back  { background:url('https://cdn.shopify.com/s/files/1/0962/6648/6067/files/Sipcard.png?v=1765319696') center/cover; }
    .card-front { background:url('https://i.imgur.com/8vK3s3Z.png') center/cover; color:#fff; text-shadow:2px 2px 8px #000; transform:rotateY(180deg); }
    .card.flipped { transform:rotateY(180deg); }
    .card.locked { opacity:0.5; pointer-events:none; }

    /* Modals */
    .phone-modal, .final-modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.97); display:none;
      align-items:center; justify-content:center; z-index:999;
    }
    .phone-modal.active, .final-modal.active { display:flex; }
    .phone-content, .final-content {
      background:#111; padding:35px; border-radius:20px; width:90%; max-width:380px;
      border:2px solid var(--green); text-align:center;
    }
    .phone-close, .final-close {
      position:absolute; top:12px; right:16px; font-size:30px; color:#666; cursor:pointer;
    }
    .phone-input {
      width:100%; padding:18px; margin:20px 0; background:#222; border:none;
      border-radius:14px; color:#fff; font-size:17px;
    }
    .btn-confirm {
      background:var(--green); color:#000; border:none; padding:18px 32px;
      border-radius:14px; font-weight:900; font-size:19px; cursor:pointer; width:100%;
    }

    .spinner { position:fixed; inset:0; background:rgba(0,0,0,0.98); display:none; align-items:center; justify-content:center; z-index:9999; }
    .spinner.active { display:flex; }
    .spinner::after {
      content:""; width:70px; height:70px; border:7px solid #222;
      border-top:7px solid var(--green); border-radius:50%; animation:spin 1s linear infinite;
    }

    /* Zoom Control */
    .zoom-control {
      position:fixed; bottom:15px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.7); backdrop-filter:blur(10px);
      padding:10px 16px; border-radius:30px; border:1px solid #333;
      color:#fff; font-size:14px; z-index:999;
      display:flex; align-items:center; gap:12px;
    }
    .zoom-control input { width:120px; }

    @keyframes marquee { 0% { transform:translateX(0); } 100% { transform:translateX(-50%); } }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body>

  <div class="container">
    <div class="title">SIP PICKER</div>
    <div class="welcome" id="welcomeMsg">Welcome <span id="username">Guest</span></div>

    <div class="balance">
      <div class="item"><span class="label">STRZ:</span> <span id="stars-count">0</span> ⭐️</div>
      <div class="item"><span class="label">CASH:</span> ₦<span id="cash-count">0</span></div>
    </div>

    <div class="marquee"><div class="marquee-inner" id="marquee"></div></div>

    <h2 class="pick-title">PICK A CARD</h2>
    <div class="cards-grid" id="cards-grid"></div>
  </div>

  <!-- Phone Modal -->
  <div class="phone-modal" id="phoneModal">
    <div class="phone-content">
      <span class="phone-close" id="phoneClose">×</span>
      <h2 style="color:var(--green);">Delivery Phone</h2>
      <p style="color:#888; margin:15px 0 25px;">We'll contact this number</p>
      <input type="tel" id="phoneInput" class="phone-input" placeholder="+234 801 234 5678">
      <button class="btn-confirm" id="phoneConfirm">CONFIRM & PICK</button>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="final-modal" id="finalModal">
    <div class="final-content">
      <span class="final-close" id="finalClose">×</span>
      <h2 style="color:var(--green);">Congratulations!</h2>
      <p id="finalMessage" style="color:#fff; margin:25px 0; font-size:18px;"></p>
    </div>
  </div>

  <div class="spinner" id="spinner"></div>

  <!-- Zoom Control -->
  <div class="zoom-control">
    <span>Zoom</span>
    <input type="range" min="80" max="120" value="100" id="zoomSlider">
    <span id="zoomValue">100%</span>
  </div>

  <!-- Confetti (colorful) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

  <!-- Sound Hooks (just paste your direct MP3 links below) -->
  <script>
    // INSERT YOUR SOUNDS HERE
    const soundCardTap = new Audio("https://example.com/card-tap.mp3");        // plays on card click
    const soundSuccess = new Audio("https://example.com/success-chime.mp3");  // plays on win

    // Optional: preload
    // soundCardTap.preload = soundSuccess.preload = "auto";

    function playTap()    { soundCardTap.currentTime = 0; soundCardTap.play().catch(()=>{}); }
    function playWin()    { soundSuccess.currentTime = 0; soundSuccess.play().catch(()=>{}); }

    function fireConfetti() {
      const colors = ['#ff6b6b','#4ecdc4','#45b7d1','#f9ca24','#f3722c','#a29bfe','#fd79a8'];
      const end = Date.now() + 3500;
      (function frame() {
        confetti({ particleCount: 6, spread: 70, origin: { y: 0.6 }, colors });
        if (Date.now() < end) requestAnimationFrame(frame);
      }());
    }

    // Zoom control
    document.getElementById('zoomSlider').addEventListener('input', function() {
      const zoom = this.value;
      document.body.style.zoom = zoom + "%";
      document.getElementById('zoomValue').textContent = zoom + "%";
    });
  </script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, onSnapshot, runTransaction, serverTimestamp, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyD_GjkTox5tum9o4AupO0LeWzjTocJg8RI",
    authDomain: "dettyverse.firebaseapp.com",
    projectId: "dettyverse",
    storageBucket: "dettyverse.firebasestorage.app",
    messagingSenderId: "1036459652488",
    appId: "1:1036459652488:web:e8910172ed16e9cac9b63d"
  });
  const db = getFirestore(app);

  let currentUser = null;
  const COST = 100;

  const drinks = ["Hennessy Paradise","Cîroc Coconut","Don Julio 1942","Moët Ice","Ace of Spades","Jack Daniel’s","Martell Blue Swift","Remy Martin XO","Grey Goose","Patrón Silver","Casamigos Blanco","1800 Coconut","D’ussé VSOP","Belvedere","Cristal","Dom Pérignon","Johnnie Walker Blue","Macallan 18","Heineken","Guinness","Red Bull","Tequila Rose","Blue Nun","Veuve Clicquot"];

  const DOM = {
    username: document.getElementById('username'),
    hostName: document.getElementById('hostName'),
    stars: document.getElementById('stars-count'),
    cash: document.getElementById('cash-count'),
    cardsGrid: document.getElementById('cards-grid'),
    marquee: document.getElementById('marquee'),
    phoneModal: document.getElementById('phoneModal'),
    phoneInput: document.getElementById('phoneInput'),
    phoneConfirm: document.getElementById('phoneConfirm'),
    phoneClose: document.getElementById('phoneClose'),
    finalModal: document.getElementById('finalModal'),
    finalMessage: document.getElementById('finalMessage'),
    finalClose: document.getElementById('finalClose'),
    spinner: document.getElementById('spinner')
  };

  const showSpinner = () => DOM.spinner.classList.add('active');
  const hideSpinner = () => DOM.spinner.classList.remove('active');
  const finalModal = msg => { DOM.finalMessage.innerHTML = msg; DOM.finalModal.classList.add('active'); };

  const emailToDocId = email => email?.includes('@') ? `${email.toLowerCase().split('@')[0]}_${email.split('@')[1].replace(/\./g,'_')}` : null;

  const loadCurrentUser = async () => {
    showSpinner();
    const stored = JSON.parse(localStorage.getItem('vipUser') || localStorage.getItem('hostUser') || '{}');
    if (!stored?.email) return hideSpinner();
    const uid = emailToDocId(stored.email);
    if (!uid) return hideSpinner();

    const userRef = doc(db, 'users', uid);
    const snap = await getDoc(userRef);
    if (!snap.exists()) {
      currentUser = { uid, stars:0, cash:0, email:stored.email };
      DOM.username.textContent = stored.email.split('@')[0];
      return hideSpinner();
    }
    const data = snap.data();
    currentUser = { uid, ...data, email:stored.email };
    DOM.username.textContent = currentUser.chatId || stored.email.split('@')[0];
    DOM.stars.textContent = (currentUser.stars||0).toLocaleString();
    DOM.cash.textContent = (currentUser.cash||0).toLocaleString();

    onSnapshot(userRef, s => {
      if (s.exists()) {
        const d = s.data();
        DOM.stars.textContent = (d.stars||0).toLocaleString();
        DOM.cash.textContent = (d.cash||0).toLocaleString();
      }
    });
    hideSpinner();
  };

  const initMarquee = () => {
    const links = ["https://cdn.shopify.com/s/files/1/0962/6648/6067/files/47.png?v=1764928903","https://cdn.shopify.com/s/files/1/0962/6648/6067/files/46.png?v=1764928904","https://cdn.shopify.com/s/files/1/0962/6648/6067/files/36.png?v=1764928903","https://cdn.shopify.com/s/files/1/0962/6648/6067/files/42.png?v=1764928903","https://cdn.shopify.com/s/files/1/0962/6648/6067/files/48.png?v=1764928903","https://cdn.shopify.com/s/files/1/0962/6648/6067/files/40.png?v=1764928903"];
    links.forEach(l => { const i = document.createElement('img'); i.src = l; DOM.marquee.appendChild(i); });
    DOM.marquee.innerHTML += DOM.marquee.innerHTML;
  };

  const initCards = () => {
    const shuffled = [...drinks].sort(()=>Math.random()-0.5);
    const numbers = Array.from({length:24},(_,i)=>i+1).sort(()=>Math.random()-0.5);
    DOM.cardsGrid.innerHTML = '';
    shuffled.forEach((drink,i) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.drink = drink;
      card.dataset.number = numbers[i];
      card.innerHTML = `<div class="card-face card-back"></div><div class="card-face card-front">${drink}</div>`;
      card.onclick = () => { playTap(); pickCard(card); };
      DOM.cardsGrid.appendChild(card);
    });
  };

  const pickCard = async (card) => {
    if (card.classList.contains('flipped')) return;
    if (!currentUser || currentUser.stars < COST) return finalModal(`Need ${COST} Stars`);
    if (!currentUser.invitedBy && !currentUser.hostName) return finalModal("Access denied");

    DOM.phoneModal.classList.add('active');
    DOM.phoneConfirm.onclick = async () => {
      const phone = DOM.phoneInput.value.trim();
      if (!phone || phone.length < 10) return finalModal('Invalid phone');

      DOM.phoneModal.classList.remove('active');
      DOM.phoneInput.value = '';
      showSpinner();

      try {
        const uid = emailToDocId(currentUser.email);
        const userRef = doc(db, 'users', uid);

        await runTransaction(db, async (t) => {
          const snap = await t.get(userRef);
          if (!snap.exists() || snap.data().stars < COST) throw "No stars";
          t.update(userRef, { stars: snap.data().stars - COST });
        });

        await addDoc(collection(db, 'drinkRequests'), {
          userId: uid, userEmail: currentUser.email,
          username: currentUser.chatId || currentUser.email.split('@')[0],
          invitedBy: currentUser.invitedBy || currentUser.hostName,
          drink: card.dataset.drink, phone, cardNumber: Number(card.dataset.number),
          timestamp: serverTimestamp(), status: 'pending', delivered: false
        });

        card.classList.add('flipped','locked');
        DOM.finalMessage.innerHTML = `<strong>Congratulations!</strong><br><br>Card #${card.dataset.number}<br><strong>${card.dataset.drink}</strong><br><br>Delivery: ${phone}`;
        DOM.finalModal.classList.add('active');
        fireConfetti();
        playWin();

        currentUser.stars -= COST;
        DOM.stars.textContent = currentUser.stars.toLocaleString();
      } catch(e) {
        finalModal('Order failed. Try again.');
      } finally { hideSpinner(); }
    };
  };

  DOM.phoneClose.onclick = () => DOM.phoneModal.classList.remove('active');
  DOM.finalClose.onclick = () => DOM.finalModal.classList.remove('active');

  loadCurrentUser();
  initMarquee();
  initCards();
</script>
</body>
</html>