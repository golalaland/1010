<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAP MASTER ADMIN — GOD MODE</title>
  <style>
    body { font-family: 'Poppins', sans-serif; background: #0a0a0a; color: #fff; padding: 20px; margin:0; }
    h1,h2 { text-align:center; margin:20px 0; color:#0f9; text-shadow:0 0 20px #0f9; }
    .tab-container { display: flex; gap: 12px; margin: 20px auto; justify-content: center; flex-wrap: wrap; }
    .tab { padding: 12px 24px; background: #222; border-radius: 50px; cursor: pointer; font-weight: 700; transition: all 0.3s; border: 2px solid transparent; }
    .tab.active { background: linear-gradient(90deg,#ff006e,#ff8c00); color: #000; border-color: #0f9; box-shadow: 0 0 30px rgba(255,0,110,0.5); }
    .section { display: none; background:#111; padding:30px; border-radius:20px; margin:20px; box-shadow:0 0 40px rgba(0,255,150,0.1); }
    .section.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin:20px 0; background:#1a1a1a; border-radius:12px; overflow:hidden; }
    th, td { padding: 14px; border: 1px solid #333; text-align: center; }
    th { background: #0f9; color:#000; font-weight:900; }
    input, button, select { padding: 10px; margin: 8px; border-radius: 12px; border: none; background:#222; color:#fff; }
    button { background: linear-gradient(135deg,#ff006e,#ff4500); font-weight:900; cursor:pointer; box-shadow:0 6px 20px rgba(255,0,110,0.4); transition:all 0.3s; }
    button:hover { transform:translateY(-3px); box-shadow:0 12px 30px rgba(255,0,110,0.6); }
    #loaderOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.98); display:none; align-items:center; justify-content:center; z-index:99999; backdrop-filter:blur(20px); }
    #loaderText { font-size:24px; color:#0f9; text-shadow:0 0 20px #0f9; }
    #adminGate { text-align:center; margin-top:100px; }
    .bid-royale { border: 3px solid #ff006e !important; background: linear-gradient(135deg,#1a0033,#2d001a) !important; }
    .daily-leaderboard { border: 3px solid #00ff9d !important; background: linear-gradient(135deg,#001a1a,#00332d) !important; }
  </style>
</head>
<body>

  <div id="loaderOverlay"><div id="loaderText">EMPIRE LOADING...</div></div>

  <!-- ADMIN GATE -->
  <div id="adminGate">
    <h2 style="font-size:48px; background:-webkit-linear-gradient(90deg,#0f9,#ff00aa); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
      ADMIN LOGIN
    </h2>
    <input id="adminEmail" type="email" placeholder="Enter Admin Email" style="width:300px;padding:16px;font-size:18px;">
    <br><br>
    <button id="adminCheckBtn" style="padding:16px 40px;font-size:20px;">ENTER THE EMPIRE</button>
    <p id="adminGateMsg" style="color:#ff6b6b;margin-top:20px;"></p>
  </div>

  <!-- MAIN DASHBOARD -->
  <div id="adminPanel" style="display:none;">
    <h1>TAP MASTER ADMIN DASHBOARD</h1>
    <button id="logoutBtn" style="position:absolute;top:20px;right:20px;padding:12px 24px;">Logout</button>

    <div class="tab-container">
      <div class="tab active" data-tab="leaderboards">Leaderboards</div>
      <div class="tab" data-tab="daily-winners">Daily Winners</div>
      <div class="tab" data-tab="bid-winners">Bid Royale Winners</div>
      <div class="tab" data-tab="daily-rewards">Daily Rewards</div>
      <div class="tab" data-tab="bid-rewards">Bid Royale Rewards</div>
      <div class="tab" data-tab="configs">Game Configs</div>
      <div class="tab" data-tab="withdrawals">Withdrawals</div>
    </div>

    <!-- DOPE ALERT -->
    <div id="dopeAlert" style="position:fixed;inset:0;background:rgba(0,0,0,0.92);backdrop-filter:blur(16px);display:none;align-items:center;justify-content:center;z-index:999999;opacity:0;transition:opacity 0.4s ease;">
      <div style="background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);padding:40px 30px;border-radius:24px;max-width:420px;width:90%;text-align:center;box-shadow:0 0 80px rgba(0,255,150,0.4),inset 0 0 40px rgba(0,255,150,0.1);border:2px solid #0f9;transform:scale(0.9);transition:transform 0.5s cubic-bezier(0.18,0.89,0.32,1.28);">
        <div style="font-size:52px;margin-bottom:16px;" id="dopeIcon">Checkmark</div>
        <h2 style="margin:0 0 16px;font-size:28px;color:#0f9;text-shadow:0 0 20px #0f9;" id="dopeTitle">Success!</h2>
        <p style="margin:0;font-size:18px;color:#fff;opacity:0.9;line-height:1.6;" id="dopeMessage">Done.</p>
        <button id="dopeClose" style="margin-top:28px;padding:14px 36px;background:#0f9;color:#000;font-weight:900;border:none;border-radius:16px;cursor:pointer;box-shadow:0 8px 20px rgba(0,255,150,0.4);">GOT IT</button>
      </div>
    </div>

    <!-- LEADERBOARDS -->
    <div id="leaderboards" class="section active">
      <h2>LIVE LEADERBOARDS</h2>
      <select id="lb-type">
        <option value="daily">Daily General</option>
        <option value="weekly">Weekly General</option>
        <option value="monthly">Monthly General</option>
        <option value="bid">Bid Royale</option>
      </select>
      <input id="lb-limit" type="number" value="50" min="10" max="100">
      <select id="bid-round" style="display:none;"></select>
      <button id="fetch-lb">Refresh</button>
      <table id="lb-table"><thead><tr><th>Rank</th><th>User</th><th>Taps</th><th>Email</th></tr></thead><tbody></tbody></table>
      <button id="save-winners">Save as Winners</button>
    </div>

    <!-- DAILY WINNERS HISTORY -->
    <div id="daily-winners" class="section daily-leaderboard">
      <h2>DAILY WINNERS HISTORY</h2>
      <input id="daily-from" type="date"> <input id="daily-to" type="date">
      <button id="fetch-daily-winners">Load Daily Winners</button>
      <button id="export-daily-csv">Export CSV</button>
      <table id="daily-winners-table"><thead><tr><th>Date</th><th>Rank</th><th>User</th><th>Taps</th><th>Rewards</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- BID ROYALE WINNERS HISTORY -->
    <div id="bid-winners" class="section bid-royale">
      <h2>BID ROYALE WINNERS HISTORY</h2>
      <button id="fetch-bid-winners">Load Bid Winners</button>
      <button id="export-bid-csv">Export CSV</button>
      <table id="bid-winners-table"><thead><tr><th>Date</th><th>Round</th><th>Rank</th><th>User</th><th>Reward</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- DAILY REWARDS -->
    <div id="daily-rewards" class="section daily-leaderboard">
      <h2>DAILY REWARDS MANAGEMENT</h2>
      <div id="daily-reward-rules"></div>
      <button id="add-daily-rule">+ Add Rule</button>
      <select id="daily-winners-date"></select>
      <button id="apply-daily-rewards">APPLY DAILY REWARDS</button>
    </div>

    <!-- BID ROYALE REWARDS -->
    <div id="bid-rewards" class="section bid-royale">
      <h2>BID ROYALE REWARDS MANAGEMENT</h2>
      <div id="bid-reward-rules"></div>
      <button id="add-bid-rule">+ Add Rule</button>
      <select id="bid-winners-date"></select>
      <button id="apply-bid-rewards">APPLY BID ROYALE REWARDS</button>
    </div>

    <!-- CONFIGS & WITHDRAWALS (unchanged) -->
    <div id="configs" class="section">...</div>
    <div id="withdrawals" class="section">...</div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where, orderBy, limit, serverTimestamp, runTransaction, addDoc, deleteDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_GjkTox5tum9o4AupO0LeWzjTocJg8RI",
      authDomain: "dettyverse.firebaseapp.com",
      projectId: "dettyverse",
      storageBucket: "dettyverse.firebasestorage.app",
      messagingSenderId: "1036459652488",
      appId: "1:1036459652488:web:e8910172ed16e9cac9b63d",
      measurementId: "G-NX2KWZW85V"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const adminGate = document.getElementById("adminGate");
    const adminPanel = document.getElementById("adminPanel");
    const adminEmailInput = document.getElementById("adminEmail");
    const adminCheckBtn = document.getElementById("adminCheckBtn");
    const adminGateMsg = document.getElementById("adminGateMsg");
    const logoutBtn = document.getElementById("logoutBtn");
    const loaderOverlay = document.getElementById("loaderOverlay");
    const loaderText = document.getElementById("loaderText");

    let currentAdmin = null;
    let currentLbData = [];
    let currentWinnersData = [];
    let lbUnsub = null;

    function showLoader(text = "Working...") {
      loaderText.textContent = text;
      loaderOverlay.style.display = "flex";
    }
    function hideLoader() { loaderOverlay.style.display = "none"; }

  function showConfirm(title = "Confirm", msg = "Are you sure?") {
  return new Promise(resolve => {
    const overlay = document.createElement("div");
    overlay.style.cssText = `
      position:fixed;inset:0;
      background:rgba(0,0,0,0.96);
      backdrop-filter:blur(20px);
      display:flex;align-items:center;justify-content:center;
      z-index:999999;
      opacity:0;
      transition:opacity 0.5s ease;
    `;

    overlay.innerHTML = `
      <div style="
        background:linear-gradient(135deg,#1a0033,#2d1b69,#0f0c29);
        padding:40px 32px;
        border-radius:28px;
        max-width:440px;
        width:92%;
        text-align:center;
        box-shadow:0 0 120px rgba(255,0,110,0.6),inset 0 0 60px rgba(0,255,150,0.15);
        border:3px solid transparent;
        background-clip:padding-box;
        position:relative;
        overflow:hidden;
        transform:scale(0.9);
        transition:transform 0.6s cubic-bezier(0.18,0.89,0.32,1.28);
      ">
        <div style="
          position:absolute;
          inset:0;
          background:linear-gradient(45deg,transparent 30%,rgba(0,255,150,0.12) 50%,transparent 70%);
          animation:shine 5s infinite;
        "></div>

        <h3 style="
          margin:0 0 20px;
          font-size:32px;
          color:#0f9;
          text-shadow:0 0 30px #0f9,0 0 60px #0f9;
          font-weight:900;
          letter-spacing:1px;
        ">${title}</h3>

        <p style="
          margin:0 0 36px;
          font-size:19px;
          color:#fff;
          line-height:1.7;
          opacity:0.95;
        ">${msg}</p>

        <div style="display:flex;gap:22px;justify-content:center;">
          <button id="no" style="
            flex:1;
            padding:18px;
            background:#222;
            color:#aaa;
            border:none;
            border-radius:20px;
            font-weight:800;
            font-size:16px;
            cursor:pointer;
            box-shadow:0 8px 25px rgba(0,0,0,0.7);
            transition:all 0.3s;
          " onmouseover="this.style.background='#444';this.style.transform='translateY(-4px)'"
             onmouseout="this.style.background='#222';this.style.transform='translateY(0)'">CANCEL</button>

          <button id="yes" style="
            flex:1;
            padding:18px;
            background:linear-gradient(90deg,#ff006e,#ff3300,#ff006e);
            color:#fff;
            border:none;
            border-radius:20px;
            font-weight:900;
            font-size:16px;
            cursor:pointer;
            box-shadow:0 12px 40px rgba(255,0,110,0.8);
            animation:pulse 2s infinite;
            background-size:200%;
            transition:all 0.4s;
          " onmouseover="this.style.transform='scale(1.08)';this.style.backgroundPosition='right'"
             onmouseout="this.style.transform='scale(1)';this.style.backgroundPosition='left'">YES, DO IT</button>
        </div>
      </div>
    `;

    // Add styles for animations
    const style = document.createElement("style");
    style.textContent = `
      @keyframes shine {
        0% { transform: translateX(-150%) translateY(-150%) rotate(30deg); }
        100% { transform: translateX(150%) translateY(150%) rotate(30deg); }
      }
      @keyframes pulse {
        0%, 100% { box-shadow: 0 12px 40px rgba(255,0,110,0.8); }
        50% { box-shadow: 0 20px 60px rgba(255,0,110,1); }
      }
    `;
    document.head.appendChild(style);

    document.body.appendChild(overlay);

    // Animate in
    setTimeout(() => {
      overlay.style.opacity = "1";
      overlay.querySelector("div > div").style.transform = "scale(1)";
    }, 50);

    // Button actions
    overlay.querySelector("#no").onclick = () => {
      overlay.style.opacity = "0";
      setTimeout(() => { overlay.remove(); style.remove(); }, 500);
      resolve(false);
    };

    overlay.querySelector("#yes").onclick = () => {
      overlay.style.opacity = "0";
      setTimeout(() => { overlay.remove(); style.remove(); }, 500);
      resolve(true);
    };

    // Click outside to cancel
    overlay.onclick = (e) => {
      if (e.target === overlay) {
        overlay.querySelector("#no").click();
      }
    };
  });
}

    function downloadCSV(filename, rows) {
      const csv = rows.map(r => r.map(c => `"${String(c ?? "").replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    adminCheckBtn.addEventListener("click", async () => {
      const email = adminEmailInput.value.trim().toLowerCase();
      if (!email) return adminGateMsg.textContent = "Enter email";
      showLoader("Checking...");
      const q = query(collection(db, "users"), where("email", "==", email));
      const snap = await getDocs(q);
      hideLoader();
      if (snap.empty) return adminGateMsg.textContent = "Not found";
      const data = snap.docs[0].data();
      if (!data.isAdmin) return adminGateMsg.textContent = "Not admin";
      currentAdmin = { id: snap.docs[0].id, email };
      adminGate.style.display = "none";
      adminPanel.style.display = "block";
      initTabs();
      await loadBidRounds();
      await loadWinnerDates();
      await loadConfigs();
      initRewardRules();
      await loadWithdrawals();
      await startLbListener(); // Start live listener for default tab
    });

    logoutBtn.addEventListener("click", () => {
      if (lbUnsub) lbUnsub();
      currentAdmin = null;
      adminPanel.style.display = "none";
      adminGate.style.display = "block";
      adminEmailInput.value = "";
      adminGateMsg.textContent = "";
    });

    // Rest of the script remains the same
    document.getElementById('lb-type').addEventListener('change', startLbListener);
    document.getElementById('lb-limit').addEventListener('change', startLbListener);
    document.getElementById('bid-round').addEventListener('change', startLbListener);

    document.getElementById('fetch-lb').addEventListener('click', startLbListener);

    document.getElementById('save-winners').addEventListener('click', async () => {
      showLoader("Saving winners...");
      await saveWinners();
      hideLoader();
    });

    document.getElementById('fetch-winners').addEventListener('click', async () => {
      showLoader("Fetching history...");
      await fetchWinnersHistory();
      hideLoader();
    });

    document.getElementById('export-csv').addEventListener('click', exportCSV);

    document.getElementById('clear-winners').addEventListener('click', async () => {
      if (await showConfirm("Clear", "Clear all winners?")) {
        showLoader("Clearing...");
        await clearWinners();
        hideLoader();
      }
    });

    document.getElementById('add-rule').addEventListener('click', addRewardRule);

    document.getElementById('apply-rewards').addEventListener('click', async () => {
      showLoader("Applying rewards...");
      await applyRewards();
      hideLoader();
    });

    document.getElementById('send-notifs').addEventListener('click', async () => {
      showLoader("Sending notifications...");
      await sendNotifications();
      hideLoader();
    });

    document.getElementById('save-configs').addEventListener('click', async () => {
      showLoader("Saving configs...");
      await saveConfigs();
      hideLoader();
    });

    document.getElementById('export-withdrawals-csv').addEventListener('click', exportWithdrawalsCSV);

    function initTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          document.getElementById(tab.dataset.tab).classList.add('active');
          if (tab.dataset.tab === 'leaderboards') {
            startLbListener();
          } else if (tab.dataset.tab === 'winners') {
            fetchWinnersHistory();
          } else if (tab.dataset.tab === 'withdrawals') {
            loadWithdrawals();
          }
          if (lbUnsub && tab.dataset.tab !== 'leaderboards') {
            lbUnsub();
            lbUnsub = null;
          }
        });
      });
    }

    async function startLbListener() {
      if (lbUnsub) lbUnsub();
      const type = document.getElementById('lb-type').value;
      const lbLimit = parseInt(document.getElementById('lb-limit').value) || 50;
      const tableBody = document.getElementById('lb-table').querySelector('tbody');
      tableBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      currentLbData = [];

      if (type === 'bid') {
        const roundId = document.getElementById('bid-round').value;
        const q = query(collection(db, 'taps'), where('roundId', '==', roundId));
        lbUnsub = onSnapshot(q, (snap) => {
          const scores = {};
          snap.forEach(d => {
            const data = d.data();
            if (!scores[data.uid]) scores[data.uid] = { uid: data.uid, username: data.username, taps: 0, email: '' };
            scores[data.uid].taps += data.count;
          });
          currentLbData = Object.values(scores).sort((a,b) => b.taps - a.taps).slice(0, lbLimit);
          renderLbTable();
        });
      } else {
        const q = collection(db, 'users');
        lbUnsub = onSnapshot(q, (snap) => {
          const key = getLeaderboardKey(type);
          const users = snap.docs.map(doc => {
            const d = doc.data();
            return { uid: doc.id, username: d.chatId, taps: d[`taps${type.charAt(0).toUpperCase() + type.slice(1)}`]?.[key] || 0, email: d.email };
          });
          currentLbData = users.filter(u => u.taps > 0).sort((a,b) => b.taps - a.taps).slice(0, lbLimit);
          renderLbTable();
        });
      }
    }

    function renderLbTable() {
      const tableBody = document.getElementById('lb-table').querySelector('tbody');
      tableBody.innerHTML = '';
      currentLbData.forEach((u, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i+1}</td><td>${u.username}</td><td>${u.taps}</td><td>${u.email || ''}</td>`;
        tableBody.appendChild(row);
      });
    }

    function getLeaderboardKey(period) {
      const now = new Date();
      if (period === 'daily') return now.toISOString().split('T')[0];
      if (period === 'weekly') return `${now.getFullYear()}-W${getWeekNumber(now)}`;
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }

    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const yearStart = new Date(d.getFullYear(), 0, 1);
      return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    }

    async function saveWinners() {
      if (currentLbData.length === 0) return dopeAlert('No data');
      const date = new Date().toISOString().split('T')[0];
      const winnersRef = doc(db, 'winners', date);
      await setDoc(winnersRef, {
        date,
        type: document.getElementById('lb-type').value,
        roundId: document.getElementById('lb-type').value === 'bid' ? document.getElementById('bid-round').value : null,
        winners: currentLbData.map((u, i) => ({ rank: i+1, ...u, rewards: { cash: 0, stars: 0 } })),
        timestamp: serverTimestamp()
      });
      dopeAlert('Saved');
      loadWinnerDates();
    }

    async function loadBidRounds() {
      const bids = await getDocs(collection(db, 'bids'));
      const uniqueRounds = [...new Set(bids.docs.map(d => d.data().roundId))].sort((a,b) => b.localeCompare(a));
      const select = document.getElementById('bid-round');
      select.innerHTML = uniqueRounds.map(r => `<option value="${r}">${r}</option>`).join('');
    }

    async function loadWinnerDates() {
      const winners = await getDocs(collection(db, 'winners'));
      const dates = winners.docs.map(d => d.id).sort((a,b) => b.localeCompare(a));
      const select = document.getElementById('reward-winners-date');
      select.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    async function fetchWinnersHistory() {
      const from = document.getElementById('winners-from').value;
      const to = document.getElementById('winners-to').value;
      let q = query(collection(db, 'winners'), orderBy('date', 'desc'));
      if (from) q = query(q, where('date', '>=', from));
      if (to) q = query(q, where('date', '<=', to));
      const snaps = await getDocs(q);
      const tableBody = document.getElementById('winners-table').querySelector('tbody');
      tableBody.innerHTML = '';
      currentWinnersData = [];
      snaps.docs.forEach(doc => {
        const data = doc.data();
        data.winners.forEach(w => {
          const rewardsStr = `Cash: ${w.rewards.cash}, Stars: ${w.rewards.stars}`;
          const row = document.createElement('tr');
          row.innerHTML = `<td>${data.date}</td><td>${w.rank}</td><td>${w.username}</td><td>${w.taps}</td><td>${rewardsStr}</td>`;
          tableBody.appendChild(row);
          currentWinnersData.push({ date: data.date, ...w });
        });
      });
    }

    function exportCSV() {
      if (currentWinnersData.length === 0) return dopeAlert('Fetch winners first');
      const headers = ['Date','Rank','User','Taps','Cash','Stars','Email'];
      const rows = [headers, ...currentWinnersData.map(w => [w.date, w.rank, w.username, w.taps, w.rewards.cash, w.rewards.stars, w.email || ''])];
      downloadCSV('winners.csv', rows);
    }

    async function clearWinners() {
      const winners = await getDocs(collection(db, 'winners'));
      for (const d of winners.docs) {
        await deleteDoc(d.ref);
      }
      dopeAlert('Cleared');
      document.getElementById('winners-table').querySelector('tbody').innerHTML = '';
      loadWinnerDates();
    }

    function initRewardRules() {
      const container = document.getElementById('reward-rules');
      addRewardRule(); // Start with one
    }

    function addRewardRule() {
      const container = document.getElementById('reward-rules');
      const rule = document.createElement('div');
      rule.innerHTML = `
        Top <input type="number" class="rule-start" value="1" min="1"> - 
        <input type="number" class="rule-end" value="10" min="1">:
        Cash <input type="number" class="rule-cash" value="5000">,
        Stars <input type="number" class="rule-stars" value="0">
      `;
      container.appendChild(rule);
    }

 async function applyRewards() {
  const date = document.getElementById('reward-winners-date').value;
  const winnersRef = doc(db, 'winners', date);
  const snap = await getDoc(winnersRef);
  if (!snap.exists()) return dopeAlert('No winners for this date', 'Error', 'Warning');

  const winnersDoc = snap.data();
  const winners = winnersDoc.winners;
  const isBidRoyale = winnersDoc.type === "bid" || winnersDoc.type === "bid_royale" || date.includes("bid_");

  // Apply your rules (unchanged)
  const rules = Array.from(document.querySelectorAll('#reward-rules > div')).map(div => ({
    start: parseInt(div.querySelector('.rule-start').value),
    end: parseInt(div.querySelector('.rule-end').value),
    cash: parseInt(div.querySelector('.rule-cash').value),
    stars: parseInt(div.querySelector('.rule-stars').value)
  }));

  winners.forEach(w => {
    for (let rule of rules) {
      if (w.rank >= rule.start && w.rank <= rule.end) {
        w.rewards = { cash: rule.cash, stars: rule.stars };
        break;
      }
    }
  });

  await updateDoc(winnersRef, { winners });

  // REWARD + SEND CONTEXT-AWARE NOTIFICATIONS
  for (let w of winners) {
    if (w.rewards.cash > 0 || w.rewards.stars > 0) {
      const userRef = doc(db, 'users', w.uid);
      await runTransaction(db, async t => {
        const u = await t.get(userRef);
        const d = u.data() || {};
        t.update(userRef, {
          cash: (d.cash || 0) + w.rewards.cash,
          stars: (d.stars || 0) + w.rewards.stars
        });
      });

      const rewardText = [];
      if (w.rewards.cash > 0) rewardText.push(`₦${w.rewards.cash.toLocaleString()} cash`);
      if (w.rewards.stars > 0) rewardText.push(`${w.rewards.stars.toLocaleString()} stars`);

      let title, message, type;

      if (isBidRoyale) {
        // BID ROYALE — EPIC WAR VIBES
        const rankText = w.rank === 1 ? "YOU ARE THE BID ROYALE CHAMPION!" :
                        w.rank === 2 ? "2ND PLACE — WARRIOR!" :
                        w.rank === 3 ? "3RD PLACE — LEGEND!" :
                        `TOP ${w.rank} — DOMINATED THE WAR!`;

        title = "BID ROYALE VICTORY!";
        message = `${rankText}\nYou crushed the arena and won ${rewardText.join(" + ")}`;
        type = "bid_royale_winner";
      } else {
        // NORMAL TAPMASTER — CLEAN DAILY WIN
        title = "TapMaster Winner!";
        message = `You placed #${w.rank} on the leaderboard!\nYou won ${rewardText.join(" + ")}`;
        type = "daily_leaderboard";
      }

      await addDoc(collection(db, "notifications"), {
        recipientId: w.uid,
        title,
        message,
        type,
        rank: w.rank,
        cash: w.rewards.cash,
        stars: w.rewards.stars,
        isBidRoyale,
        createdAt: serverTimestamp(),
        read: false
      });
    }
  }

  const eventName = isBidRoyale ? "BID ROYALE" : "DAILY LEADERBOARD";
  dopeAlert(
    `${eventName} REWARDS SENT!\n${winners.filter(w => w.rewards.cash || w.rewards.stars).length} players paid`,
    isBidRoyale ? "WAR IS OVER" : "DAILY WINS DISTRIBUTED",
    isBidRoyale ? "Crown" : "Trophy",
    8000
  );
}
    async function loadConfigs() {
      const configRef = doc(db, 'configs', 'game');
      const snap = await getDoc(configRef);
      if (snap.exists()) {
        const d = snap.data();
        document.getElementById('bid-cost').value = d.BID_COST;
        document.getElementById('pool-increase').value = d.POOL_INCREASE_PER_PLAYER;
        document.getElementById('base-pool').value = d.BASE_PRIZE_POOL;
        document.getElementById('max-pool').value = d.MAX_PRIZE_POOL || 0;
      }
    }

    async function saveConfigs() {
      const configRef = doc(db, 'configs', 'game');
      await setDoc(configRef, {
        BID_COST: parseInt(document.getElementById('bid-cost').value),
        POOL_INCREASE_PER_PLAYER: parseInt(document.getElementById('pool-increase').value),
        BASE_PRIZE_POOL: parseInt(document.getElementById('base-pool').value),
        MAX_PRIZE_POOL: parseInt(document.getElementById('max-pool').value) || null
      });
      dopedopeAlert('Configs saved');
    }

    async function loadWithdrawals() {
      const tableBody = document.getElementById('withdrawals-table').querySelector('tbody');
      tableBody.innerHTML = '';
      const q = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
      const snap = await getDocs(q);
      snap.forEach(d => {
        const w = d.data();
        let dateStr = "Unknown";
        if (w.requestedAt?.toDate) dateStr = w.requestedAt.toDate().toLocaleString();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${dateStr}</td>
          <td>${w.username || "—"}</td>
          <td>${(w.uid || "").replace(/_/g, ".")}</td>
          <td>₦${(w.amount || 0).toLocaleString()}</td>
          <td>${w.bankName || "—"}</td>
          <td>${w.bankAccountNumber || "—"}</td>
          <td>${w.status || "pending"}</td>
          <td>${w.status === "pending" ? '<button class="resolve-withdraw">Resolve</button>' : 'Done'}</td>
        `;
        const resolveBtn = row.querySelector('.resolve-withdraw');
        if (resolveBtn) {
          resolveBtn.addEventListener('click', async () => {
            if (await showConfirm('Resolve', `Mark as resolved?`)) {
              showLoader('Resolving...');
              await updateDoc(doc(db, 'withdrawals', d.id), { status: 'resolved', resolvedAt: serverTimestamp() });
              hideLoader();
              loadWithdrawals();
            }
          });
        }
        tableBody.appendChild(row);
      });
    }

    async function exportWithdrawalsCSV() {
      const rows = [['Date','Username','Amount','Status']];
      const snap = await getDocs(collection(db, 'withdrawals'));
      snap.forEach(d => {
        const w = d.data();
        rows.push([w.requestedAt?.toDate?.().toLocaleString() || '—', w.username||'', w.amount||0, w.status||'pending']);
      });
      downloadCSV('withdrawals.csv', rows);
    }
    // DOPE ALERT — REPLACE ALL alert() CALLS
function dopeAlert(message, title = "Done!", icon = "Checkmark", duration = 5000) {
  const alertBox = document.getElementById("dopeAlert");
  const iconEl = document.getElementById("dopeIcon");
  const titleEl = document.getElementById("dopeTitle");
  const msgEl = document.getElementById("dopeMessage");

  // Set content
  titleEl.textContent = title;
  msgEl.textContent = message;
  iconEl.innerHTML = icon;

  // Show + animate in
  alertBox.style.display = "flex";
  setTimeout(() => {
    alertBox.style.opacity = "1";
    document.querySelectorAll("#dopeAlert > div > *").forEach((el, i) => {
      setTimeout(() => {
        el.style.opacity = "1";
        el.style.transform = "translateY(0) scale(1)";
      }, i * 150);
    });
  }, 50);

  // Auto close
  const autoClose = setTimeout(() => closeDope(), duration);

  // Manual close
  document.getElementById("dopeClose").onclick = () => {
    clearTimeout(autoClose);
    closeDope();
  };

  function closeDope() {
    alertBox.style.opacity = "0";
    setTimeout(() => alertBox.style.display = "none", 400);
  }
}

// OVERRIDE NATIVE alert() — NOW IT'S DOPE
window.alert = function(message) {
  dopeAlert(message, "Alert", "Warning", 7000);
};
  </script>
</body>
</html>
