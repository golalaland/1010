<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tap Master Admin Dashboard</title>
  <style>
    body { font-family: 'Poppins', sans-serif; background: #0a0a0a; color: #fff; padding: 20px; }
    .tab-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: #333; border-radius: 8px; cursor: pointer; }
    .tab.active { background: #0f9; color: #000; }
    .section { display: none; }
    .section.active { display: block; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border: 1px solid #333; text-align: left; }
    input, button { padding: 8px; margin: 5px; border-radius: 5px; border: none; }
    button { background: #0f9; color: #000; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #loaderOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 9999; }
    #loaderText { color: #0f9; font-size: 18px; }
    #adminGate { text-align: center; margin-top: 50px; }
    #adminGateMsg { color: #ff6b6b; }
  </style>
</head>
<body>
  <div id="loaderOverlay"><div id="loaderText">Working...</div></div>

  <div id="adminGate">
    <h2>Admin Login</h2>
    <input id="adminEmail" type="email" placeholder="Admin Email">
    <button id="adminCheckBtn">Login</button>
    <p id="adminGateMsg"></p>
  </div>

  <div id="adminPanel" style="display: none;">
    <h1>Tap Master Admin Dashboard</h1>
    <button id="logoutBtn">Logout</button>
    <div class="tab-container">
      <div class="tab active" data-tab="leaderboards">Leaderboards</div>
      <div class="tab" data-tab="winners">Winners History</div>
      <div class="tab" data-tab="rewards">Rewards Management</div>
      <div class="tab" data-tab="configs">Game Configs</div>
      <div class="tab" data-tab="withdrawals">Withdrawals</div>
    </div>

    <div id="leaderboards" class="section active">
      <h2>Leaderboard Feeds (Live)</h2>
      <select id="lb-type">
        <option value="daily">Daily General</option>
        <option value="weekly">Weekly General</option>
        <option value="monthly">Monthly General</option>
        <option value="bid">Bid Royale</option>
      </select>
      <input id="lb-limit" type="number" placeholder="Top N (e.g. 50)" value="50">
      <select id="bid-round" style="display:none;"></select>
      <button id="fetch-lb">Refresh</button>
      <table id="lb-table">
        <thead><tr><th>Rank</th><th>User</th><th>Taps</th><th>Email</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="save-winners">Save Current as Today's Winners</button>
    </div>

    <div id="winners" class="section">
      <h2>Winners History</h2>
      <input id="winners-from" type="date" placeholder="From Date">
      <input id="winners-to" type="date" placeholder="To Date">
      <button id="fetch-winners">Fetch Winners</button>
      <button id="export-csv">Export as CSV</button>
      <button id="clear-winners">Clear All Winners</button>
      <table id="winners-table">
        <thead><tr><th>Date</th><th>Rank</th><th>User</th><th>Taps</th><th>Rewards</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="rewards" class="section">
      <h2>Rewards Management</h2>
      <p>Set batch rewards (e.g., top 1-10: cash 5000, stars 0)</p>
      <div id="reward-rules"></div>
      <button id="add-rule">Add Reward Rule</button>
      <select id="reward-winners-date"></select>
      <button id="apply-rewards">Apply & Mass Send Rewards</button>
      <button id="send-notifs">Send Custom Notifications</button>
      <textarea id="notif-message" placeholder="Custom notification message"></textarea>
    </div>

    <div id="configs" class="section">
      <h2>Game Configurations</h2>
      <input id="bid-cost" type="number" placeholder="Bid Cost (Stars)">
      <input id="pool-increase" type="number" placeholder="Pool Increase per Player">
      <input id="base-pool" type="number" placeholder="Base Prize Pool">
      <input id="max-pool" type="number" placeholder="Max Prize Pool (0 for unlimited)">
      <button id="save-configs">Save Configs</button>
    </div>

    <div id="withdrawals" class="section">
      <h2>Withdrawals Management</h2>
      <table id="withdrawals-table">
        <thead><tr><th>Date</th><th>Username</th><th>UID</th><th>Amount</th><th>Bank</th><th>Account</th><th>Status</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="export-withdrawals-csv">Export Withdrawals CSV</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where, orderBy, limit, serverTimestamp, runTransaction, addDoc, deleteDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_GjkTox5tum9o4AupO0LeWzjTocJg8RI",
      authDomain: "dettyverse.firebaseapp.com",
      projectId: "dettyverse",
      storageBucket: "dettyverse.firebasestorage.app",
      messagingSenderId: "1036459652488",
      appId: "1:1036459652488:web:e8910172ed16e9cac9b63d",
      measurementId: "G-NX2KWZW85V"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const adminGate = document.getElementById("adminGate");
    const adminPanel = document.getElementById("adminPanel");
    const adminEmailInput = document.getElementById("adminEmail");
    const adminCheckBtn = document.getElementById("adminCheckBtn");
    const adminGateMsg = document.getElementById("adminGateMsg");
    const logoutBtn = document.getElementById("logoutBtn");
    const loaderOverlay = document.getElementById("loaderOverlay");
    const loaderText = document.getElementById("loaderText");

    let currentAdmin = null;
    let currentLbData = [];
    let currentWinnersData = [];
    let lbUnsub = null;

    function showLoader(text = "Working...") {
      loaderText.textContent = text;
      loaderOverlay.style.display = "flex";
    }
    function hideLoader() { loaderOverlay.style.display = "none"; }

    function showConfirm(title, msg) {
      return new Promise(resolve => {
        const overlay = document.createElement("div");
        overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:999999;backdrop-filter:blur(12px);";
        overlay.innerHTML = `
          <div style="background:#111;padding:32px;border-radius:18px;text-align:center;max-width:380px;width:90%;box-shadow:0 0 60px rgba(255,0,110,0.5);border:1px solid #444;">
            <h3 style="color:#fff;margin:0 0 16px;font-size:22px;">${title}</h3>
            <p style="color:#ccc;margin:0 0 24px;line-height:1.6;">${msg}</p>
            <div style="display:flex;gap:16px;justify-content:center;">
              <button id="no" style="padding:12px 28px;background:#333;color:#ccc;border:none;border-radius:12px;font-weight:600;cursor:pointer;">Cancel</button>
              <button id="yes" style="padding:12px 28px;background:linear-gradient(90deg,#ff006e,#ff4500);color:#fff;border:none;border-radius:12px;font-weight:700;cursor:pointer;">Confirm</button>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        overlay.querySelector("#no").onclick = () => { overlay.remove(); resolve(false); };
        overlay.querySelector("#yes").onclick = () => { overlay.remove(); resolve(true); };
      });
    }

    function downloadCSV(filename, rows) {
      const csv = rows.map(r => r.map(c => `"${String(c ?? "").replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    adminCheckBtn.addEventListener("click", async () => {
      const email = adminEmailInput.value.trim().toLowerCase();
      if (!email) return adminGateMsg.textContent = "Enter email";
      showLoader("Checking...");
      const q = query(collection(db, "users"), where("email", "==", email));
      const snap = await getDocs(q);
      hideLoader();
      if (snap.empty) return adminGateMsg.textContent = "Not found";
      const data = snap.docs[0].data();
      if (!data.isAdmin) return adminGateMsg.textContent = "Not admin";
      currentAdmin = { id: snap.docs[0].id, email };
      adminGate.style.display = "none";
      adminPanel.style.display = "block";
      initTabs();
      await loadBidRounds();
      await loadWinnerDates();
      await loadConfigs();
      initRewardRules();
      await loadWithdrawals();
      await startLbListener(); // Start live listener for default tab
    });

    logoutBtn.addEventListener("click", () => {
      if (lbUnsub) lbUnsub();
      currentAdmin = null;
      adminPanel.style.display = "none";
      adminGate.style.display = "block";
      adminEmailInput.value = "";
      adminGateMsg.textContent = "";
    });

    // Rest of the script remains the same
    document.getElementById('lb-type').addEventListener('change', startLbListener);
    document.getElementById('lb-limit').addEventListener('change', startLbListener);
    document.getElementById('bid-round').addEventListener('change', startLbListener);

    document.getElementById('fetch-lb').addEventListener('click', startLbListener);

    document.getElementById('save-winners').addEventListener('click', async () => {
      showLoader("Saving winners...");
      await saveWinners();
      hideLoader();
    });

    document.getElementById('fetch-winners').addEventListener('click', async () => {
      showLoader("Fetching history...");
      await fetchWinnersHistory();
      hideLoader();
    });

    document.getElementById('export-csv').addEventListener('click', exportCSV);

    document.getElementById('clear-winners').addEventListener('click', async () => {
      if (await showConfirm("Clear", "Clear all winners?")) {
        showLoader("Clearing...");
        await clearWinners();
        hideLoader();
      }
    });

    document.getElementById('add-rule').addEventListener('click', addRewardRule);

    document.getElementById('apply-rewards').addEventListener('click', async () => {
      showLoader("Applying rewards...");
      await applyRewards();
      hideLoader();
    });

    document.getElementById('send-notifs').addEventListener('click', async () => {
      showLoader("Sending notifications...");
      await sendNotifications();
      hideLoader();
    });

    document.getElementById('save-configs').addEventListener('click', async () => {
      showLoader("Saving configs...");
      await saveConfigs();
      hideLoader();
    });

    document.getElementById('export-withdrawals-csv').addEventListener('click', exportWithdrawalsCSV);

    function initTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          document.getElementById(tab.dataset.tab).classList.add('active');
          if (tab.dataset.tab === 'leaderboards') {
            startLbListener();
          } else if (tab.dataset.tab === 'winners') {
            fetchWinnersHistory();
          } else if (tab.dataset.tab === 'withdrawals') {
            loadWithdrawals();
          }
          if (lbUnsub && tab.dataset.tab !== 'leaderboards') {
            lbUnsub();
            lbUnsub = null;
          }
        });
      });
    }

    async function startLbListener() {
      if (lbUnsub) lbUnsub();
      const type = document.getElementById('lb-type').value;
      const lbLimit = parseInt(document.getElementById('lb-limit').value) || 50;
      const tableBody = document.getElementById('lb-table').querySelector('tbody');
      tableBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      currentLbData = [];

      if (type === 'bid') {
        const roundId = document.getElementById('bid-round').value;
        const q = query(collection(db, 'taps'), where('roundId', '==', roundId));
        lbUnsub = onSnapshot(q, (snap) => {
          const scores = {};
          snap.forEach(d => {
            const data = d.data();
            if (!scores[data.uid]) scores[data.uid] = { uid: data.uid, username: data.username, taps: 0, email: '' };
            scores[data.uid].taps += data.count;
          });
          currentLbData = Object.values(scores).sort((a,b) => b.taps - a.taps).slice(0, lbLimit);
          renderLbTable();
        });
      } else {
        const q = collection(db, 'users');
        lbUnsub = onSnapshot(q, (snap) => {
          const key = getLeaderboardKey(type);
          const users = snap.docs.map(doc => {
            const d = doc.data();
            return { uid: doc.id, username: d.chatId, taps: d[`taps${type.charAt(0).toUpperCase() + type.slice(1)}`]?.[key] || 0, email: d.email };
          });
          currentLbData = users.filter(u => u.taps > 0).sort((a,b) => b.taps - a.taps).slice(0, lbLimit);
          renderLbTable();
        });
      }
    }

    function renderLbTable() {
      const tableBody = document.getElementById('lb-table').querySelector('tbody');
      tableBody.innerHTML = '';
      currentLbData.forEach((u, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i+1}</td><td>${u.username}</td><td>${u.taps}</td><td>${u.email || ''}</td>`;
        tableBody.appendChild(row);
      });
    }

    function getLeaderboardKey(period) {
      const now = new Date();
      if (period === 'daily') return now.toISOString().split('T')[0];
      if (period === 'weekly') return `${now.getFullYear()}-W${getWeekNumber(now)}`;
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }

    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const yearStart = new Date(d.getFullYear(), 0, 1);
      return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    }

    async function saveWinners() {
      if (currentLbData.length === 0) return alert('No data');
      const date = new Date().toISOString().split('T')[0];
      const winnersRef = doc(db, 'winners', date);
      await setDoc(winnersRef, {
        date,
        type: document.getElementById('lb-type').value,
        roundId: document.getElementById('lb-type').value === 'bid' ? document.getElementById('bid-round').value : null,
        winners: currentLbData.map((u, i) => ({ rank: i+1, ...u, rewards: { cash: 0, stars: 0 } })),
        timestamp: serverTimestamp()
      });
      alert('Saved');
      loadWinnerDates();
    }

    async function loadBidRounds() {
      const bids = await getDocs(collection(db, 'bids'));
      const uniqueRounds = [...new Set(bids.docs.map(d => d.data().roundId))].sort((a,b) => b.localeCompare(a));
      const select = document.getElementById('bid-round');
      select.innerHTML = uniqueRounds.map(r => `<option value="${r}">${r}</option>`).join('');
    }

    async function loadWinnerDates() {
      const winners = await getDocs(collection(db, 'winners'));
      const dates = winners.docs.map(d => d.id).sort((a,b) => b.localeCompare(a));
      const select = document.getElementById('reward-winners-date');
      select.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    async function fetchWinnersHistory() {
      const from = document.getElementById('winners-from').value;
      const to = document.getElementById('winners-to').value;
      let q = query(collection(db, 'winners'), orderBy('date', 'desc'));
      if (from) q = query(q, where('date', '>=', from));
      if (to) q = query(q, where('date', '<=', to));
      const snaps = await getDocs(q);
      const tableBody = document.getElementById('winners-table').querySelector('tbody');
      tableBody.innerHTML = '';
      currentWinnersData = [];
      snaps.docs.forEach(doc => {
        const data = doc.data();
        data.winners.forEach(w => {
          const rewardsStr = `Cash: ${w.rewards.cash}, Stars: ${w.rewards.stars}`;
          const row = document.createElement('tr');
          row.innerHTML = `<td>${data.date}</td><td>${w.rank}</td><td>${w.username}</td><td>${w.taps}</td><td>${rewardsStr}</td>`;
          tableBody.appendChild(row);
          currentWinnersData.push({ date: data.date, ...w });
        });
      });
    }

    function exportCSV() {
      if (currentWinnersData.length === 0) return alert('Fetch winners first');
      const headers = ['Date','Rank','User','Taps','Cash','Stars','Email'];
      const rows = [headers, ...currentWinnersData.map(w => [w.date, w.rank, w.username, w.taps, w.rewards.cash, w.rewards.stars, w.email || ''])];
      downloadCSV('winners.csv', rows);
    }

    async function clearWinners() {
      const winners = await getDocs(collection(db, 'winners'));
      for (const d of winners.docs) {
        await deleteDoc(d.ref);
      }
      alert('Cleared');
      document.getElementById('winners-table').querySelector('tbody').innerHTML = '';
      loadWinnerDates();
    }

    function initRewardRules() {
      const container = document.getElementById('reward-rules');
      addRewardRule(); // Start with one
    }

    function addRewardRule() {
      const container = document.getElementById('reward-rules');
      const rule = document.createElement('div');
      rule.innerHTML = `
        Top <input type="number" class="rule-start" value="1" min="1"> - 
        <input type="number" class="rule-end" value="10" min="1">:
        Cash <input type="number" class="rule-cash" value="5000">,
        Stars <input type="number" class="rule-stars" value="0">
      `;
      container.appendChild(rule);
    }

    async function applyRewards() {
      const date = document.getElementById('reward-winners-date').value;
      const winnersRef = doc(db, 'winners', date);
      const snap = await getDoc(winnersRef);
      if (!snap.exists()) return alert('No winners for this date');
      let winners = snap.data().winners;

      const rules = Array.from(document.querySelectorAll('#reward-rules > div')).map(div => ({
        start: parseInt(div.querySelector('.rule-start').value),
        end: parseInt(div.querySelector('.rule-end').value),
        cash: parseInt(div.querySelector('.rule-cash').value),
        stars: parseInt(div.querySelector('.rule-stars').value)
      }));

      winners = winners.map(w => {
        for (let rule of rules) {
          if (w.rank >= rule.start && w.rank <= rule.end) {
            w.rewards = { cash: rule.cash, stars: rule.stars };
            break;
          }
        }
        return w;
      });

      await updateDoc(winnersRef, { winners });

      // Mass update users
      for (let w of winners) {
        if (w.rewards.cash > 0 || w.rewards.stars > 0) {
          const userRef = doc(db, 'users', w.uid);
          await runTransaction(db, async t => {
            const u = await t.get(userRef);
            const d = u.data();
            t.update(userRef, {
              cash: (d.cash || 0) + w.rewards.cash,
              stars: (d.stars || 0) + w.rewards.stars
            });
          });
        }
      }
      alert('Rewards applied and sent');
    }

    async function sendNotifications() {
      const message = document.getElementById('notif-message').value;
      if (!message) return alert('Enter message');
      const date = document.getElementById('reward-winners-date').value;
      const winnersRef = doc(db, 'winners', date);
      const snap = await getDoc(winnersRef);
      if (!snap.exists()) return alert('No winners');
      const winners = snap.data().winners;
      for (let w of winners) {
        await addDoc(collection(db, 'notifications'), {
          uid: w.uid,
          message,
          timestamp: serverTimestamp()
        });
      }
      alert('Notifications sent');
    }

    async function loadConfigs() {
      const configRef = doc(db, 'configs', 'game');
      const snap = await getDoc(configRef);
      if (snap.exists()) {
        const d = snap.data();
        document.getElementById('bid-cost').value = d.BID_COST;
        document.getElementById('pool-increase').value = d.POOL_INCREASE_PER_PLAYER;
        document.getElementById('base-pool').value = d.BASE_PRIZE_POOL;
        document.getElementById('max-pool').value = d.MAX_PRIZE_POOL || 0;
      }
    }

    async function saveConfigs() {
      const configRef = doc(db, 'configs', 'game');
      await setDoc(configRef, {
        BID_COST: parseInt(document.getElementById('bid-cost').value),
        POOL_INCREASE_PER_PLAYER: parseInt(document.getElementById('pool-increase').value),
        BASE_PRIZE_POOL: parseInt(document.getElementById('base-pool').value),
        MAX_PRIZE_POOL: parseInt(document.getElementById('max-pool').value) || null
      });
      alert('Configs saved');
    }

    async function loadWithdrawals() {
      const tableBody = document.getElementById('withdrawals-table').querySelector('tbody');
      tableBody.innerHTML = '';
      const q = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
      const snap = await getDocs(q);
      snap.forEach(d => {
        const w = d.data();
        let dateStr = "Unknown";
        if (w.requestedAt?.toDate) dateStr = w.requestedAt.toDate().toLocaleString();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${dateStr}</td>
          <td>${w.username || "—"}</td>
          <td>${(w.uid || "").replace(/_/g, ".")}</td>
          <td>₦${(w.amount || 0).toLocaleString()}</td>
          <td>${w.bankName || "—"}</td>
          <td>${w.bankAccountNumber || "—"}</td>
          <td>${w.status || "pending"}</td>
          <td>${w.status === "pending" ? '<button class="resolve-withdraw">Resolve</button>' : 'Done'}</td>
        `;
        const resolveBtn = row.querySelector('.resolve-withdraw');
        if (resolveBtn) {
          resolveBtn.addEventListener('click', async () => {
            if (await showConfirm('Resolve', `Mark as resolved?`)) {
              showLoader('Resolving...');
              await updateDoc(doc(db, 'withdrawals', d.id), { status: 'resolved', resolvedAt: serverTimestamp() });
              hideLoader();
              loadWithdrawals();
            }
          });
        }
        tableBody.appendChild(row);
      });
    }

    async function exportWithdrawalsCSV() {
      const rows = [['Date','Username','Amount','Status']];
      const snap = await getDocs(collection(db, 'withdrawals'));
      snap.forEach(d => {
        const w = d.data();
        rows.push([w.requestedAt?.toDate?.().toLocaleString() || '—', w.username||'', w.amount||0, w.status||'pending']);
      });
      downloadCSV('withdrawals.csv', rows);
    }
  </script>
</body>
</html>
